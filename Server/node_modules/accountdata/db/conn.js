var connection = null;
var mongodb = require('mongodb');

exports.withDb = function(callback) {
    if (connection) return callback(null, connection);
    else {
        var host = new mongodb.Server('127.0.0.1', 27017, { });
        var options = {safe: true, auto_reconnect: true};
        mongodb.Db('cubes', host, options).open(function (e, c) {
            connection = c;
            callback(e, c);
        });
    }
}

function ensureIndexes(indexes, db, callback) {
    if (indexes.length == 0) return callback(null);
    var info = indexes[0];
    var collection = db.collection(info.collection);
    collection.ensureIndex(info.index, {'unique': true}, function (err) {
        if (err) return callback(err);
        ensureIndexes(indexes.slice(1), db, callback);
    });
}

exports.initializeDb = function(callback) {
    exports.withDb(function (err1, db) {
        if (err1) return callback(err1);
        var indexes = [
            {'collection': 'accounts', 'index': {'username': 1}},
            {'collection': 'puzzles', 'index': {'account': 1, 'id': 1}},
            {'collection': 'sessions', 'index': {'account': 1, 'id': 1}},
        ];
        ensureIndexes(indexes, db, callback);
    });
}
