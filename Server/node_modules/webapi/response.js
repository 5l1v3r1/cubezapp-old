var keyedbits = require('keyedbits');
var accountdata = require('accountdata');
var fs = require('fs');
var path = require('path');

// sends a keyedbits packet with a specified status and encoding type
function sendPacket(status, dictionary, contentType, response) {
    var buffer = new keyedbits.buffer();
    var encoder = new keyedbits.encode(buffer);
    if (!encoder.encode(dictionary)) return null;
    var theData = null;
    if (contentType == 'application/keyedbits') {
        theData = new Buffer(buffer.array);
    } else {
        theData = keyedbits.base64.encode(buffer);
    }
    response.writeHead(status, {'Content-Type': contentType,
                                'Content-Length': theData.length});
    response.end(theData);
}

// decodes a keyedbits packet based on the data and encoding type
function decodePacket(aBuffer, contentType) {
    // decode possible HTTP encoding
    var buffer = null;
    if (contentType == 'application/keyedbits64') {
        buffer = keyedbits.base64.decode(aBuffer.toString());
    } else {
        buffer = accountdata.db.convert.convertData(aBuffer, 'KBBuffer');
    }
    if (!buffer) return null;

    // decode keyedbits data
    var decoded = null;
    try {
        var decoder = new keyedbits.decode(buffer);
        decoded = decoder.decode();
    } catch (e) {
        return null;
    }
    if (typeof decoded != 'object') return null;
    
    // decode packet
    if (!decoded['call'] || !decoded['object']) {
        return null;
    }
    if (typeof decoded['call'] != 'string' ||
        typeof decoded['object'] != 'object') {
        return null;
    }

    // decode API object
    var ClientPacket = accountdata.packet.ClientPacket;
    var packet = new ClientPacket(decoded['call'], decoded['object']);
    if (!packet.validate()) return null;
    
    return packet;
};

function lookupHandler(name, callback) {
    var fileName = path.resolve(__dirname, 'handlers/' + name + '.js');
    fs.exists(fileName, function (exists) {
        if (!exists) return null;
        var aModule = require(fileName);
        if (!aModule) return null;
        callback(aModule.handler);
    });
}

// dispatches a handler and assumes ownership of the response pipeline
exports.respond = function(buffer, contentType, response) {
    var packet = decodePacket(buffer, contentType);
    if (!packet) {
        return sendPacket(400, {'error': 'Failed to parse packet'}, contentType, response);
    }
    lookupHandler(packet.getAPIDomain(), function (constructor) {
        if (!constructor) {
            return sendPacket(400, {'error': 'API not found'}, contentType, response);
        }
        var handler = new constructor(packet, contentType);
        handler.handle(function (err, dictionary) {
            if (err) {
                sendPacket(400, {'error': err.message}, contentType, response);
            } else {
                sendPacket(200, dictionary, contentType, response);
            }
        });
    });
}
